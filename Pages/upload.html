<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Upload Portal</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-button">‚¨Ö Back to Home</a>
        <h1>Teacher Upload Portal</h1>

        <div class="donate-container">
            <form action="https://www.paypal.com/donate" method="post" target="_top">
                <input type="hidden" name="hosted_button_id" value="H4VS859BVGF66" />
                <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
                <img alt="" border="0" src="https://www.paypal.com/en_DE/i/scr/pixel.gif" width="1" height="1" />
            </form>
        </div>
        
        <div id="uploadForm" class="explanation-box" style="text-align: left;">
            <label>Resource Category:</label>
            <select id="resourceCategory" style="width:100%; margin-bottom:10px;">
                <option value="external">YouTube / External Link</option>
                <option value="printable">Printable (PDF/PowerPoint/Image)</option>
            </select>

            <label>Resource Title:</label>
            <input type="text" id="fileTitle" placeholder="e.g. Present Perfect Worksheet" style="width:100%; margin-bottom:10px; padding: 8px;">

            <label>Topic / Subject:</label>
            <input type="text" id="fileTopic" list="topicSuggestions" placeholder="e.g. Grammar, Business, Phonics" style="width:100%; margin-bottom:10px; padding: 8px;">
            <datalist id="topicSuggestions"></datalist>

            <label>Age Group:</label>
            <input type="text" id="fileAge" list="ageSuggestions" placeholder="e.g. Adults, Teens, Children" style="width:100%; margin-bottom:10px; padding: 8px;">
            <datalist id="ageSuggestions"></datalist>

            <label>Teacher / Source:</label>
            <input type="text" id="fileTeacher" placeholder="Your name or source website" style="width:100%; margin-bottom:10px; padding: 8px;">

            <label>Language:</label>
            <input type="text" id="fileLanguage" list="langSuggestions" placeholder="e.g. English, German, Spanish" style="width:100%; margin-bottom:10px; padding: 8px;">
            <datalist id="langSuggestions"></datalist>

            <div id="linkInputSection">
                <label>External URL:</label>
                <input type="url" id="externalUrl" placeholder="https://youtube.com/..." style="width:100%; margin-bottom:10px; padding: 8px;">
            </div>

            <div id="fileInputSection" style="display:none;">
                <label>Upload File:</label>
                <input type="file" id="filePicker" style="width:100%; margin-bottom:10px;">
                <small>Max size: 50MB (PDF, PPTX, JPG, PNG)</small>
            </div>

            <div id="customFieldsContainer" style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                <label style="font-weight: bold; color: #673AB7;">Custom Details:</label>
                <div id="dynamicFieldsList"></div>
                <button type="button" id="addCustomFieldBtn" style="background:#673AB7; color:white; border:none; padding:5px 10px; margin:10px 0; cursor:pointer; border-radius:4px; font-size:0.8em;">
                    ‚ûï Add Custom Field (e.g. Level, Duration)
                </button>
            </div>

            <button id="uploadBtn" style="width:100%; padding:12px; background-color:#28a745; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">
                üöÄ Upload to Library
            </button>
            <p id="status" style="margin-top:10px; text-align:center; font-weight:bold;"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVNUfj11PBHmjoPmDtudky9z6MHAdCsLw",
            authDomain: "one-stop-shop-5e668.firebaseapp.com",
            projectId: "one-stop-shop-5e668",
            storageBucket: "one-stop-shop-5e668.firebasestorage.app",
            messagingSenderId: "158039043020",
            appId: "1:158039043020:web:424c94c7feda5b3004cb69"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DYNAMIC FIELD LOGIC ---
        const addFieldBtn = document.getElementById('addCustomFieldBtn');
        const dynamicFieldsList = document.getElementById('dynamicFieldsList');

        addFieldBtn.addEventListener('click', () => {
            const fieldName = prompt("Enter the name for the new field (e.g., Level, Duration):");
            if (!fieldName) return;

            const cleanKey = fieldName.trim().replace(/\s+/g, '_').toLowerCase();
            
            const fieldHTML = `
                <div class="custom-field-row" style="margin-bottom:10px; background:#f0f0f0; padding:10px; border-radius:5px; position:relative;">
                    <label style="font-size:0.8em; color:#673AB7; font-weight:bold;">${cleanKey.toUpperCase()}:</label>
                    <button type="button" onclick="this.parentElement.remove()" style="position:absolute; right:5px; top:5px; background:none; border:none; color:red; cursor:pointer;">√ó</button>
                    <input type="text" class="custom-data-input" data-key="${cleanKey}" placeholder="Enter value..." style="width:100%; margin-top:5px; padding:5px; box-sizing:border-box;">
                </div>
            `;
            dynamicFieldsList.insertAdjacentHTML('beforeend', fieldHTML);
        });

        // --- POPULATE SUGGESTIONS FROM DATABASE ---
        async function populateSuggestions() {
            try {
                const resSnap = await getDocs(collection(db, "resources"));
                const printSnap = await getDocs(collection(db, "printables"));
                const allData = [...resSnap.docs, ...printSnap.docs].map(d => d.data());

                const getUnique = (key) => [...new Set(allData.map(item => item[key]?.trim().toLowerCase()).filter(Boolean))].sort();

                document.getElementById('topicSuggestions').innerHTML = getUnique('topic').map(t => `<option value="${t.charAt(0).toUpperCase() + t.slice(1)}">`).join('');
                document.getElementById('ageSuggestions').innerHTML = getUnique('ageGroup').map(a => `<option value="${a.charAt(0).toUpperCase() + a.slice(1)}">`).join('');
                document.getElementById('langSuggestions').innerHTML = getUnique('language').map(l => `<option value="${l.charAt(0).toUpperCase() + l.slice(1)}">`).join('');
            } catch (e) { console.error("Suggestions error:", e); }
        }
        populateSuggestions();

        // --- UI TOGGLE ---
        const categorySelect = document.getElementById('resourceCategory');
        categorySelect.addEventListener('change', () => {
            const isPrintable = categorySelect.value === 'printable';
            document.getElementById('fileInputSection').style.display = isPrintable ? 'block' : 'none';
            document.getElementById('linkInputSection').style.display = isPrintable ? 'none' : 'block';
        });

        // --- UPLOAD LOGIC ---
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.addEventListener('click', async () => {
            const title = document.getElementById('fileTitle').value;
            const topic = document.getElementById('fileTopic').value.trim().toLowerCase();
            const age = document.getElementById('fileAge').value.trim().toLowerCase();
            const teacher = document.getElementById('fileTeacher').value;
            const language = document.getElementById('fileLanguage').value.trim().toLowerCase();
            const status = document.getElementById('status');

            if (!title || !topic || !age) return alert("Please fill in Title, Topic, and Age.");

            uploadBtn.disabled = true;
            status.innerText = "‚è≥ Processing upload...";

            try {
                // 1. Build the base document object
                let finalDoc = {
                    title, 
                    topic, 
                    teacher, 
                    ageGroup: age, 
                    language,
                    createdAt: new Date(),
                    favoritesCount: 0,
                    feedback: []
                };

                // 2. Add any dynamic custom fields
                document.querySelectorAll('.custom-data-input').forEach(input => {
                    const key = input.getAttribute('data-key');
                    if (key && input.value.trim()) {
                        finalDoc[key] = input.value.trim();
                    }
                });

                const collectionName = categorySelect.value === 'printable' ? "printables" : "resources";

                if (categorySelect.value === 'printable') {
                    const file = document.getElementById('filePicker').files[0];
                    if (!file) throw new Error("Please select a file.");

                    const storagePath = `printables/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    const snapshot = await uploadBytes(storageRef, file);
                    finalDoc.url = await getDownloadURL(snapshot.ref);
                    finalDoc.storagePath = storagePath;
                } else {
                    const linkUrl = document.getElementById('externalUrl').value;
                    if (!linkUrl) throw new Error("Please paste a URL.");
                    finalDoc.url = linkUrl;
                }

                // 3. Save to Firebase
                await addDoc(collection(db, collectionName), finalDoc);

                status.innerText = "‚úÖ Success! Added to the library.";
                
                // Clear the form
                document.getElementById('fileTitle').value = "";
                document.getElementById('dynamicFieldsList').innerHTML = "";
                populateSuggestions();
            } catch (error) {
                status.innerText = "‚ùå Error: " + error.message;
            } finally {
                uploadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>