<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Upload Portal</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-button">‚¨Ö Back to Home</a>
        <h1>Teacher Upload Portal</h1>
        
        <div id="uploadForm" class="explanation-box" style="text-align: left;">
            <label>Resource Title:</label>
            <input type="text" id="fileTitle" placeholder="e.g. Irregular Verbs List" style="width:100%; margin-bottom:10px;">
            
            <label>Topic:</label>
            <select id="fileTopic" style="width:100%; margin-bottom:10px;">
                <option value="grammar">Grammar</option>
                <option value="vocabulary">Vocabulary</option>
                <option value="reading">Reading</option>
                <option value="writing">Writing</option>
                <option value="speaking">Speaking</option>
                <option value="listening">Listening</option>
                <option value="general">General</option>
            </select>
            <label>Material Type:</label>
            <select id="fileType" style="width:100%; margin-bottom:10px;">
                <option value="PDF">PDF / Worksheet</option>
                <option value="Video">Video Link / File</option>
                <option value="Image">Infographic / Image</option>
                <option value="PowerPoint">PowerPoint / Slides</option>
            </select>

            <label>Target Age:</label>
            <select id="fileAge" style="width:100%; margin-bottom:10px;">
                <option value="Children">Children</option>
                <option value="Teens">Teens</option>
                <option value="Adults">Adults</option>
                <option value="All">All</option>
            </select>
            <label>Teacher Name:</label>
            <input type="text" id="teacherName" placeholder="Your Name" style="width:100%; margin-bottom:10px;">

            <label>Select File (PDF):</label>
            <input type="file" id="filePicker" accept=".pdf" style="margin-bottom:20px;">

            <button id="uploadBtn" class="back-button" style="background-color: #4CAF50; width: 100%;">üöÄ Upload Resource</button>
            <p id="status"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVNUfj11PBHmjoPmDtudky9z6MHAdCsLw",
            authDomain: "one-stop-shop-5e668.firebaseapp.com",
            projectId: "one-stop-shop-5e668",
            storageBucket: "one-stop-shop-5e668.firebasestorage.app",
            messagingSenderId: "158039043020",
            appId: "1:158039043020:web:424c94c7feda5b3004cb69"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);

        const uploadBtn = document.getElementById('uploadBtn');
        const status = document.getElementById('status');

        uploadBtn.addEventListener('click', async () => {
            const file = document.getElementById('filePicker').files[0];
            const title = document.getElementById('fileTitle').value;
            const topic = document.getElementById('fileTopic').value;
            const type = document.getElementById('fileType').value;
            const age = document.getElementById('fileAge').value;
            const teacher = document.getElementById('teacherName').value;

            if (!file || !title || !teacher) {
                alert("Please fill in all fields and select a file!");
                return;
            }

            // STOP if file is larger than 5MB
            if (file.size > 5 * 1024 * 1024) { 
                alert("File is too big! Please keep it under 5MB.");
                return;
            }

        // 2. Disable button to prevent double-submissions
            uploadBtn.disabled = true;
            status.innerText = "‚è≥ Uploading... please wait.";

            try {
                // 1. Upload File to Storage
                const storagePath = `printables/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, storagePath);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                // 2. Save Tags/Meta to Firestore
                await addDoc(collection(db, "printables"), {
                title: title,
                topic: topic,
                teacher: teacher,
                type: type,
                ageGroup: age,
                url: downloadURL,
                storagePath: storagePath, // Make sure this matches!
                createdAt: new Date()
                });

                status.innerText = "‚úÖ Success! Resource added to library.";
                document.getElementById('fileTitle').value = "";
            } catch (error) {
                console.error(error);
                status.innerText = "‚ùå Error uploading. Check console.";
            } finally {
                uploadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>